---
import { ActivityService } from '@/lib/services/activity';
import Layout from '@/layouts/Layout.astro';
import { ActivityCard } from '@/components/admin/activity-card';

const { DB } = Astro.locals.runtime.env;
const activityService = new ActivityService(DB);
const summary = await activityService.getDailySummary();
const activities = await activityService.getAll();
const recentActivities = activities.slice(0, 5);

const metrics = [
  {
    name: 'Atividades do dia',
    value: summary.totalActivities,
    description: 'Total de registos iniciados hoje',
  },
  {
    name: 'Utilizadores ativos',
    value: summary.distinctUsers,
    description: 'Colaboradores que registaram tempo hoje',
  },
  {
    name: 'Tempo total',
    value: formatDuration(summary.totalSeconds),
    description: 'Tempo acumulado nas atividades de hoje',
  }
];

function formatDuration(totalSeconds: number) {
  if (!totalSeconds) return '0m';
  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = totalSeconds % 60;

  const parts = [];
  if (hours) parts.push(`${hours}h`);
  if (minutes) parts.push(`${minutes}m`);
  if (!hours && !minutes && seconds) parts.push(`${seconds}s`);
  return parts.join(' ') || '0m';
}
---

<Layout title="Lumio Dashboard">
  <div class="space-y-8">
    <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3 mt-4">
      {metrics.map((item) => (
        <div class="rounded-xl border bg-card text-card-foreground shadow">
          <div class="p-6 space-y-2">
            <div class="text-sm font-medium text-muted-foreground">{item.name}</div>
            <div class="text-3xl font-bold">{item.value}</div>
            <p class="text-xs text-muted-foreground">{item.description}</p>
          </div>
        </div>
      ))}
    </div>

    <section class="space-y-4">
      <h2 class="text-2xl font-semibold tracking-tight">Ultimas atividades</h2>
      {recentActivities.length ? (
        <div class="space-y-3">
          {recentActivities.map((activity) => (
            <ActivityCard activity={activity} />
          ))}
        </div>
      ) : (
        <p class="text-muted-foreground">Ainda nao existem atividades registadas hoje.</p>
      )}
    </section>
  </div>
</Layout>
